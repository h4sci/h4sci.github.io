<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Minna Heim">

<title>Leverage APIs for Economic Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="guest-lecture_files/libs/clipboard/clipboard.min.js"></script>
<script src="guest-lecture_files/libs/quarto-html/quarto.js"></script>
<script src="guest-lecture_files/libs/quarto-html/popper.min.js"></script>
<script src="guest-lecture_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="guest-lecture_files/libs/quarto-html/anchor.min.js"></script>
<link href="guest-lecture_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="guest-lecture_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="guest-lecture_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="guest-lecture_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="guest-lecture_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Leverage APIs for Economic Data</h1>
<p class="subtitle lead">Data Handling Guest Lecture 2025</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Minna Heim </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<!-- TODO: find a better way of citing -->
<p>What you see in the plot below is the KOF Economic Barometer, which is responsible for predicting how the Swiss economy will perform in the near future<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. The Barometer includes other time series data which have an economically plausible influence on the Swiss business cycle. For the KOF Barometer specifically, this means synthesizing more than 300 distinct variables (each representing a separate time series) into a single indicator that captures the complex dynamics of the Swiss economy.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="guest-lecture_files/figure-html/kofdata-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The reason I’m presenting this Economic Index to you is that although this blog post is about APIs and their usage for economic data, we will explore the beginning of what it takes to create our own Economic Index—namely, what it takes to efficiently gather more than 300 time series.</p>
<p>By the end of this blog post, <strong>you will gain a better understanding of APIs and their usage</strong>, but moreover, you will have built your own API wrapper, and even potentially, your own API. All of this will hopefully help you identify APIs in the real world. After this, <strong>you will hopefully realize that APIs are used everywhere</strong>, from Art Museums to COVID-19 case rates.</p>
<p><br>
</p>
<section id="getting-data-the-naive-way" class="level3">
<h3 class="anchored" data-anchor-id="getting-data-the-naive-way">Getting Data, the Naive Way</h3>
<p>Let’s go back to our initial example: when trying to gather the data to build our economic Index, how would we do this?</p>
<p>The Naive Way of doing this would be to google the data we need from the Swiss Federal Statistical Office (BFS), such as Swiss GDP - which is a good representation of economic activity, but not the only one - and see what we can find.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/google_datasets.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Then, by clicking on the BFS’ Website, we could find their Economic Data Portal.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/wirtschaftsdaten.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>Then, after inputting our desired time series, we would find different variations of gdp data.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/search.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>After downloading the dataset from BFS, we can open and inspect it. The data is in excel and in wide format (meaning values are horizontally oriented) because it is more humanly readable this way, and nicer to look at.</p>
<p>When programming, we often prefer it to be in long format (values vertically oriented) because it makes plotting and cleaning easier. Most time series data is represented in this way<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/downloaded.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:80.0%"></p>
</figure>
</div>
<p>So, once downloaded, we have to manipulate the data so that it fits our purpose:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(readxl)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(magrittr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>data <span class="ot">&lt;-</span> <span class="fu">read_xlsx</span>(<span class="st">"je-d-04.02.01.03.xlsx"</span>)</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co"># subset only the rows 3 (= year) and 9 (= gdp)</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>gdp <span class="ot">&lt;-</span> data[<span class="dv">9</span>,]</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">names</span>(gdp) <span class="ot">&lt;-</span> data[<span class="dv">3</span>,]</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># pivot data longer (from excel wide format to data frame long format)</span></span>
<span id="cb1-12"><a href="#cb1-12"></a>gdp_long <span class="ot">&lt;-</span> gdp <span class="sc">%&gt;%</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>  <span class="fu">pivot_longer</span>(</span>
<span id="cb1-14"><a href="#cb1-14"></a>    <span class="at">cols =</span> <span class="fu">everything</span>(),</span>
<span id="cb1-15"><a href="#cb1-15"></a>    <span class="at">names_to =</span> <span class="st">"Year"</span>,</span>
<span id="cb1-16"><a href="#cb1-16"></a>    <span class="at">values_to =</span> <span class="st">"GDP"</span></span>
<span id="cb1-17"><a href="#cb1-17"></a>  )</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co"># remove old headers</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>gdp_long <span class="ot">&lt;-</span> gdp_long[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>),]</span>
<span id="cb1-21"><a href="#cb1-21"></a></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co"># check structure</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co"># str(gdp_long)</span></span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co"># convert to gdp numeric and year to year</span></span>
<span id="cb1-26"><a href="#cb1-26"></a>gdp_long<span class="sc">$</span>GDP <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(gdp_long<span class="sc">$</span>GDP)</span>
<span id="cb1-27"><a href="#cb1-27"></a>gdp_long<span class="sc">$</span>Year <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(gdp_long<span class="sc">$</span>Year)</span>
<span id="cb1-28"><a href="#cb1-28"></a></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="fu">head</span>(gdp_long, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We read in our data, then select the rows which we need, which is the aggregated GDP, and the date. Then we pivot our data (which transforms the data from horizontally oriented to vertically oriented), and remove old headers. Finally, we make sure our variables are represented in their correct format. Then, after all of this, our data looks like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
    Year     GDP
   &lt;int&gt;   &lt;dbl&gt;
 1  1995 423515.
 2  1996 426882.
 3  1997 433747.
 4  1998 444955.
 5  1999 453531.
 6  2000 476794.
 7  2001 489674.
 8  2002 489293.
 9  2003 493652.
10  2004 508608.</code></pre>
</div>
</div>
<p>Finally, we have successfully searched for, imported and cleaned our first time series dataset for our Economic Index.</p>
<p>It was quite a long and intensive process, wasn’t it? We had to look for the correct data, download, and then clean it all. Given that we have approximately 299 time series to go, this approach could become quite unruly and complicated—especially if we want to repeat this process in the future. When it’s a new year and we want to include the newest data into our analysis, we would have to repeat the entire process!</p>
<p>Moreover, since GDP is quite the common dataset, it’s made readily available and published in a well known format, like excel. But once we get to more niche time series, finding and importing and cleaning could become a lot more difficult.</p>
<p>Let’s introduce a different method for extracting data from a public source that is more repeatable, and reproducible (we want to do it using code).</p>
<p><br>
</p>
</section>
<section id="getting-data-the-api-wrapper-way" class="level3">
<h3 class="anchored" data-anchor-id="getting-data-the-api-wrapper-way">Getting Data, the API (wrapper) Way:</h3>
<p>I’ve made the statement before, that the “naive way” of doing things becomes unruly and complicated - the reason why APIs are preferred over this method is because when using APIs <strong>everything is standardized, thanks to protocols</strong>.</p>
<p>API stands for Application Programming Interface, and essentially standardizes the way in which your computer communicates with another computer. Protocols are just explicit set of rules which need to be followed. APIs use something called HTTP - which dictates how all data transfer happens over the web. You might have already seen HTTP in your browser (e.g.&nbsp;http://url…) this is because your browser on your computer and the server also communicate via HTTP.</p>
<p>But just communicating via http:// in our browser is not enough. This approach is still not reproducible, since we need to input the urls every time we want to get our data. We want to find a <strong>solution that is reproducible and which uses code</strong>. In other words, we want our R code to communicate with the server - so we use APIs.</p>
<section id="two-important-things-about-http" class="level4">
<h4 class="anchored" data-anchor-id="two-important-things-about-http">Two important things about HTTP</h4>
<p>There are 2 main important things I want you to know about HTTP:</p>
<ol type="1">
<li>it uses <em>client &amp; server</em> and <em>request &amp; response</em> protocols (aka clients request something from the server, the server sends a response)</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_conceptual_1.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ol start="2" type="1">
<li>There are 4 main <strong>HTTP request methods</strong> used to determine the type of data exchange happening:</li>
</ol>
<ul>
<li><strong>GET</strong> : retrieves data</li>
<li><strong>POST</strong> : sends data</li>
<li><strong>PUT</strong>: changes the data</li>
<li><strong>DELETE</strong> : deletes data</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_conceptual_2.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="how-an-api-looks-like-where-how-what" class="level4">
<h4 class="anchored" data-anchor-id="how-an-api-looks-like-where-how-what">How an API looks like: Where, How, What</h4>
<p>Now that we know that APIs use the HTTP protocol, let’s put it all together to explain what an API looks like.</p>
<p>The <strong>request</strong> (which is how we communicate to the server what we want it to do) consists of:</p>
<ul>
<li>one of the HTTP request methods, such as GET (to get data) and</li>
<li>the <strong>Where</strong> which is Base URL, since it represents the location of the server.</li>
<li>the <strong>Which service</strong> is specified through the Endpoint, which dictates what the client wants to do, i.e.&nbsp;get data, users, etc.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_conceptual_3.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<ul>
<li>then the <strong>How</strong> is specified with additional parameters. You can think of them like search filters. There are 2 main types of parameters:
<ul>
<li><em>path parameters</em>, like <code>/users/{userID}</code> or</li>
<li><em>query parameters</em> like <code>/users?ID=userID</code> (&amp; can also be used to separate multiple body params)</li>
</ul></li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_conceptual_4.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Once a request is sent to the server, it gives back a <strong>response</strong>:</p>
<ul>
<li><strong>Status</strong>: if the request was successful or unsuccessful</li>
<li><strong>Response Body</strong>: depending on the request you might get requested data, an acknowledgment that a resource was created or updated, an error message. Common formats of the response body are JSON and HTML.</li>
</ul>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_conceptual_5.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
</section>
<section id="example-the-museum-of-modern-art" class="level4">
<h4 class="anchored" data-anchor-id="example-the-museum-of-modern-art">Example: The Museum of Modern Art</h4>
<p>Let’s use what we’ve learnt to look at an example:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_url.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>The Museum of Modern Art has an API which can be used to determine what kind of artworks they have, based on certain keywords in the artworks title.</p>
<p>Example URL: <a href="https://collectionapi.metmuseum.org/public/collection/v1/search?q=bread">https://collectionapi.metmuseum.org/public/collection/v1/search?q=bread</a></p>
<p>This is a GET request to the Met Museum Collection API. It consists of:</p>
<ul>
<li>the base URL: https://collectionapi.metmuseum.org/public/collection/v1</li>
<li>the endpoint: /search</li>
<li>a query parameter: q=bread (the search keyword)</li>
</ul>
<p>The API returns JSON containing the total number of matching objects and an array of objectIDs for items that match the keyword. Try pasting the URL into your browser and replace “bread” with any other keyword to see different results.</p>
<p>I encourage you to try out GET API call yourself, by putting in the URL of the Example into your browser and inputting your own search word. Since HTTP is used on the web, we can perform the GET request via our browser as well.</p>
<p><br>
</p>
</section>
</section>
<section id="api-wrappers" class="level3">
<h3 class="anchored" data-anchor-id="api-wrappers">API Wrappers</h3>
<p>The most frequent way we as programmers encounter APIs is through so called API wrappers, you can think of them like simple programs that are intermediaries between you and your API, so they wrap the API.</p>
<p>API wrappers usually allow you to do complex API calls in an easier environment and are tailored to your programming language, so usually easier for us to use.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/api_wrapper.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Here is a visual example of how you might encounter the previous example in an API wrapper. Notice how the functionality stays the same, we can perform the same tasks, but we see and interact with less complexity. This is something we call information hiding.</p>
<p>There are many API rappers in R that you can use for your future analyses, to name a few:</p>
<ul>
<li>the <a href="https://www.rdocumentation.org/packages/kofdata/versions/0.2.1">kofdata</a> R Package (for KOF data)</li>
<li>the <a href="https://felixluginbuhl.com/BFS/">BFS</a> R package (for Swiss federal statistics)</li>
<li>the <a href="https://pypi.org/project/fredapi/">fredapi</a> Python Library (for US economic data)</li>
<li>the <a href="https://sboysel.github.io/fredr/">fredr</a> data from the Federal Reserve Economic Data (FRED) API R package</li>
<li><a href="https://github.com/public-apis/public-apis">public-apis</a> a Github repository listing Public APIs</li>
</ul>
<section id="use-the-bfs-api-wrapper-for-r" class="level4">
<h4 class="anchored" data-anchor-id="use-the-bfs-api-wrapper-for-r">Use the BFS API Wrapper for R</h4>
<p>Let’s go back to our example of getting data from the Swiss Federal Statistical Office (BFS). Since we have already imported and cleaned our gdp data, we want to move on to the next relevant time series. One other factor that could be a good predictor for economic activity in Switzerland is energy consumption over time.</p>
<p>Luckily for us, we can use the BFS’ API wrapper, which is the <a href="https://cran.r-project.org/web/packages/BFS/index.html">BFS R Package</a> to get our energy data.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># devtools::install_github("lgnbhl/BFS")</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">library</span>(BFS)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># to inspect functions, use ?function, e.g.</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>?bfs_get_catalog_data</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a>catalog <span class="ot">&lt;-</span> <span class="fu">bfs_get_catalog_data</span>(<span class="at">language =</span> <span class="st">"en"</span>, <span class="at">title =</span> <span class="st">"energy"</span>)</span>
<span id="cb3-8"><a href="#cb3-8"></a>dataset_nr <span class="ot">&lt;-</span> catalog<span class="sc">$</span>number_bfs[<span class="dv">1</span>]</span>
<span id="cb3-9"><a href="#cb3-9"></a>energy_df <span class="ot">&lt;-</span> <span class="fu">bfs_get_data</span>(dataset_nr, <span class="at">lang =</span> <span class="st">"en"</span>)</span>
<span id="cb3-10"><a href="#cb3-10"></a></span>
<span id="cb3-11"><a href="#cb3-11"></a><span class="co"># filter only total energy accounts</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>total_energy <span class="ot">&lt;-</span> <span class="fu">subset</span>(</span>
<span id="cb3-13"><a href="#cb3-13"></a>  energy_df,</span>
<span id="cb3-14"><a href="#cb3-14"></a>  <span class="co"># filter for totals for each of the columns</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>  <span class="st">`</span><span class="at">Economy and households</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Economy and households - Total"</span> <span class="sc">&amp;</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>  <span class="st">`</span><span class="at">Energy product</span><span class="st">`</span> <span class="sc">==</span> <span class="st">"Energy product - Total"</span>,</span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="co"># select only the two relevant columns</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>  <span class="at">select =</span> <span class="fu">c</span>(Year, <span class="st">`</span><span class="at">Energy accounts of economy and households</span><span class="st">`</span>)</span>
<span id="cb3-19"><a href="#cb3-19"></a>)</span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a><span class="fu">names</span>(total_energy)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"Amount"</span></span>
<span id="cb3-22"><a href="#cb3-22"></a></span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="co"># View(total_energy)</span></span>
<span id="cb3-24"><a href="#cb3-24"></a><span class="fu">head</span>(total_energy, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s go through the code line-by-line:</p>
<p>First we install and load the package, then we can inspect the functions we will use, such as <code>bfs_get_catalog_data</code> to see that we can use this function to determine what kind of data BFS publishes, based on keywords.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  title                 language number_bfs number_asset publication_date url_px
  &lt;chr&gt;                 &lt;chr&gt;    &lt;chr&gt;      &lt;chr&gt;        &lt;date&gt;           &lt;chr&gt; 
1 Energy accounts of e… en       px-x-0204… 36179320     2025-09-30       https…</code></pre>
</div>
</div>
<p>We search for energy datasets, save the respective ID of the dataset, and then GET the data, using the <code>bfs_get_data</code> function.</p>
<p>After line 9, we are already done with the API usage for this example. The rest is just filtering the dataset to get only the columns of interest (total Energy Product across all Economy and Households)</p>
<p>When inspecting the data, it looks like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   Year    Amount
   &lt;chr&gt;    &lt;dbl&gt;
 1 2000  1103603.
 2 2001  1127768.
 3 2002  1112879.
 4 2003  1130842.
 5 2004  1131767.
 6 2005  1121999.
 7 2006  1157170.
 8 2007  1126804.
 9 2008  1158734.
10 2009  1136915.</code></pre>
</div>
</div>
<p><br>
</p>
</section>
</section>
<section id="from-api-wrappers-to-apis-proper" class="level3">
<h3 class="anchored" data-anchor-id="from-api-wrappers-to-apis-proper">From API Wrappers to APIs proper</h3>
<p>In theory, we could be done with this example - using API wrappers instead of manually looking for data on the web makes it easier for us to scale our example - meaning we can easily fetch our 300 time series with little extra effort.</p>
<p>Still, to get a deeper understanding of how APIs work, we could also take a look at how API Wrappers work under the hood. Luckily for us, R packages like BFS are open source (like the R programming language) so we can see how a function such as <code>bfs_get_data</code> is written. We can go to the Package author’s github page, and <a href="https://github.com/lgnbhl/BFS/blob/master/R/bfs_get_data.R">find the function</a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/bfs_get_data.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>This might look a bit complex, so let’s break it down by looking at the essential code:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>bfs_get_data <span class="ot">&lt;-</span> <span class="cf">function</span>(number_bfs, <span class="at">language =</span> <span class="st">"de"</span>, <span class="at">query =</span> <span class="cn">NULL</span>, <span class="at">column_name_type =</span> <span class="st">"text"</span>, <span class="at">variable_value_type =</span> <span class="st">"text"</span>, <span class="at">clean_names =</span> <span class="cn">FALSE</span>, <span class="at">delay =</span> <span class="cn">NULL</span>) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="co"># base url</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>  df_json <span class="ot">&lt;-</span> httr2<span class="sc">::</span><span class="fu">request</span>(<span class="st">"https://www.pxweb.bfs.admin.ch/api/v1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="co"># add path params</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    httr2<span class="sc">::</span><span class="fu">req_url_path_append</span>(<span class="fu">paste0</span>(language, <span class="st">"/"</span>, number_bfs, <span class="st">"/"</span>, number_bfs, <span class="st">".px"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    httr2<span class="sc">::</span><span class="fu">req_retry</span>(<span class="at">max_tries =</span> <span class="dv">2</span>, <span class="at">max_seconds =</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="co"># executre request</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>    httr2<span class="sc">::</span><span class="fu">req_perform</span>() <span class="sc">%&gt;%</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>    <span class="co"># transform response to json</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>    httr2<span class="sc">::</span><span class="fu">resp_body_json</span>(<span class="at">simplifyVector =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<!-- TODO: add explanation about pxweb -->
<p>In essence, the function uses the existing API to build a request, then perform it, and save the response body.</p>
<p>Here, we build the request with the base URL, then append this URL with our path parameters which are the dataset ID and the language, and then perform the request and specify that the response body (which contains the data) should be in JSON.</p>
<p>Important to mention here, is that these above functions are used to fetch the general structure of the data, i.e.&nbsp;the units, and different data categories. This information is then being used to fetch the actual data via the px-web API which is a way of distributing data that statistical offices like to use. In principle, we could also use the functions presented above to get the data, and other API wrappers in R that you can find do so.</p>
<p>We can also try running the final URL which we create with the above functions (up to line 5) in our browser<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, as we did before, to see what the structure of our data looks like:</p>
<p><img src="img/browser.png" class="img-fluid"></p>
<p><br>
<br>
</p>
</section>
<section id="why-apis" class="level2">
<h2 class="anchored" data-anchor-id="why-apis">Why APIs?</h2>
<p>By now you might have gathered an idea or two about why APIs are important and good to use.</p>
<p>Here are some additional benefits:</p>
<ul>
<li><strong>Consistency</strong>: directly from the source, and up-to-date data (important for time series revisions)</li>
<li><strong>Speed and Scalability</strong>: as seen in our example, getting hundreds of time series through googling and searching is not scalable or quick</li>
<li><strong>Automation</strong>: the collection of data can be automated easily</li>
<li><strong>Easier to fetch data</strong>: some data is difficult to find and the specification of variables or certain time frames is easier to do.</li>
<li><strong>APIs are used everywhere!</strong> - Understanding how they work help you identify how data transfer happens</li>
</ul>
<p><br>
<br>
</p>
</section>
<section id="exercises" class="level2">
<h2 class="anchored" data-anchor-id="exercises">Exercises:</h2>
<p>Now that APIs have been thoroughly introduced and their importance is clearer, try to build your own API wrapper.</p>
<p>Most commonly used APIs already have pre-built API wrappers, but it could be that they are not available in your programming language of choice, or are not maintained, or they don’t exist at all. In that case, knowing how to go about building your own API wrapper could be very useful.</p>
<p>In R, the most commonly used package to work with Web APIs is the <a href="https://httr2.r-lib.org/">httr2 package</a> - on their website, you can find the documentation to get started with using httr2. A short cheatsheet summarizes the essential functions:</p>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Function</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Request</strong></td>
<td><code>request()</code></td>
<td>Creates a new HTTP request object that defines the endpoint and method (e.g., GET, POST).</td>
</tr>
<tr class="even">
<td><strong>Request</strong></td>
<td><code>req_perform()</code></td>
<td>Sends the built request to the server and <em>returns the response object</em>.</td>
</tr>
<tr class="odd">
<td><strong>Response</strong></td>
<td><code>resp_body_json()</code></td>
<td>Parses the response body as JSON and returns it as an R list.</td>
</tr>
<tr class="even">
<td><strong>Response</strong></td>
<td><code>resp_status()</code></td>
<td>Retrieves the HTTP status from the response object.</td>
</tr>
</tbody>
</table>
<p><br>
</p>
<section id="build-your-own-function-wrapping-the-covid-api" class="level3">
<h3 class="anchored" data-anchor-id="build-your-own-function-wrapping-the-covid-api">Build your own function wrapping the COVID API</h3>
<p>Let’s take stock of the datasets that we’ve gathered so far: we have swiss gdp and energy consumption. Now, let’s say we want to look at how the COVID pandemic has affected the Swiss Economy. To understand this better, we would need to look at COVID case and vaccination rates.</p>
<p>Luckily, the <a href="https://disease.sh/docs/">disease.sh docs</a> provides not only an open API for disease-related statistics, but also nice API documentation. We can look at various APIs and try out their endpoints! Try it out!</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/swagger_overview.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Here we can see various COVID-19 APIs, such as from Worldometer or Johns Hopkins University.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/historical_endpoint.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>Selecting one endpoint to try out, we can identify the historical case counts of certain countries.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="/img/try_out_endpoint.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>When trying out the endpoint, we can even get the data as responses, and see all of the components of a real API call.</p>
<p>Let’s try to turn this example into an actual function:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb7-2"><a href="#cb7-2"></a></span>
<span id="cb7-3"><a href="#cb7-3"></a>get_case_counts <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">country =</span> <span class="st">"CH"</span>, <span class="at">period =</span> <span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">365</span>, <span class="st">"all"</span>)){</span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="co"># "https://disease.sh/v3/covid-19/historical/CH?lastdays=30"</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="co"># this way is error prone, try to match.args to check if the inputs are correct</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  base_url <span class="ot">&lt;-</span> <span class="st">"https://disease.sh/v3/covid-19/historical"</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  final_url <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"/"</span>, country, <span class="st">"?lastdays="</span>, period)</span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="co"># perform API call with httr2</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  req <span class="ot">&lt;-</span> <span class="fu">request</span>(final_url)</span>
<span id="cb7-11"><a href="#cb7-11"></a>  resp <span class="ot">&lt;-</span> <span class="fu">req_perform</span>(req)</span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="co"># if request is not successful</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb7-15"><a href="#cb7-15"></a>    <span class="fu">message</span>(<span class="st">"The request was not successful"</span>)</span>
<span id="cb7-16"><a href="#cb7-16"></a>  }</span>
<span id="cb7-17"><a href="#cb7-17"></a>  <span class="cf">else</span>{</span>
<span id="cb7-18"><a href="#cb7-18"></a>    <span class="fu">return</span>(<span class="fu">resp_body_json</span>(resp))</span>
<span id="cb7-19"><a href="#cb7-19"></a>  }</span>
<span id="cb7-20"><a href="#cb7-20"></a>}</span>
<span id="cb7-21"><a href="#cb7-21"></a></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="fu">get_case_counts</span>(<span class="st">"CH"</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When running the last line <code>get_case_counts("CH", 1)</code> we get the following output</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>$country
[1] "Switzerland"

$province
$province[[1]]
[1] "mainland"


$timeline
$timeline$cases
$timeline$cases$`3/9/23`
[1] 4413911


$timeline$deaths
$timeline$deaths$`3/9/23`
[1] 14210


$timeline$recovered
$timeline$recovered$`3/9/23`
[1] 0</code></pre>
</div>
</div>
<p>Here it’s important to note that the Johns Hopkins University apparently stopped releasing this data after 3.9.2023 and it does seem a bit implausible that there are 0 recoveries on that day - alas!</p>
<p><br>
</p>
</section>
<section id="your-turn" class="level3">
<h3 class="anchored" data-anchor-id="your-turn">Your turn!</h3>
<p>Use the same documentation as above (<a href="https://disease.sh/docs/">disease.sh docs</a>) to get the historical vaccination doses delivered for a specific country.</p>
<p>Try out the desired endpoint using the documentation, before writing your own function.</p>
<p>Feel free to use this function as a template:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="fu">library</span>(httr2)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>get_country_vaccine_counts <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">country =</span> <span class="st">"CH"</span>, <span class="at">period =</span> <span class="fu">c</span>(<span class="dv">30</span>,<span class="dv">365</span>, <span class="st">"all"</span>)){</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>  base_url <span class="ot">&lt;-</span> <span class="st">"..."</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  final_url <span class="ot">&lt;-</span> <span class="st">"..."</span></span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a>  <span class="co"># perform  API call with httr2</span></span>
<span id="cb9-9"><a href="#cb9-9"></a>  req <span class="ot">&lt;-</span> <span class="st">"..."</span>(final_url)</span>
<span id="cb9-10"><a href="#cb9-10"></a>  resp <span class="ot">&lt;-</span> <span class="st">"..."</span>(req)</span>
<span id="cb9-11"><a href="#cb9-11"></a></span>
<span id="cb9-12"><a href="#cb9-12"></a>  <span class="co"># if request is not successful</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  <span class="cf">if</span> (<span class="fu">resp_status</span>(resp) <span class="sc">!=</span> <span class="dv">200</span>){</span>
<span id="cb9-14"><a href="#cb9-14"></a>    <span class="fu">message</span>(<span class="st">"The request was not successful"</span>)</span>
<span id="cb9-15"><a href="#cb9-15"></a>  }</span>
<span id="cb9-16"><a href="#cb9-16"></a>  <span class="cf">else</span>{</span>
<span id="cb9-17"><a href="#cb9-17"></a>    <span class="fu">return</span>(<span class="fu">resp_body_json</span>(resp))</span>
<span id="cb9-18"><a href="#cb9-18"></a>  }</span>
<span id="cb9-19"><a href="#cb9-19"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Try out your built function! What does it return?<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<p>Congratulations on adding one more dataset to your collection for your economic indicator.</p>
<p><br>
<br>
</p>
</section>
</section>
<section id="bonus-build-your-own-api" class="level2">
<h2 class="anchored" data-anchor-id="bonus-build-your-own-api">Bonus: Build Your own API:</h2>
<p>In case this is still not enough for you, and you not only want to know how to build use and build API wrapper, but you also want to build your own (web) API, I’ve got just the exercise for you.</p>
<p>With the <a href="https://www.rplumber.io/">plumber R package</a> you can build your own web API, to get an even deeper understanding of what APIs do, and how to build one using R. Plumber is a lightweight R package that turns R functions into web APIs.</p>
<p>You could use the plumber package to replicate the KOF API, which provides users the ability to get a lot of different public time series data which the Swiss Economic Institute (KOF-ETH) produces and provides. To do this, just follow the example below:</p>
<section id="example-building-a-kof-barometer-api---the-basic-menu" class="level3">
<h3 class="anchored" data-anchor-id="example-building-a-kof-barometer-api---the-basic-menu">Example: Building a KOF Barometer API - The Basic Menu</h3>
<p>Think of building this API and it’s endpoint as a different service your API restaurant offers. Or, think of it like the layers of an onion: start simple, then add layers of functionality as needed. Begin with the outermost, easiest layer:</p>
<ul>
<li>an “Everything Please” endpoint that returns the full time series.</li>
<li>a “Custom Order” endpoint that accepts start/end parameters and uses a helper to slice the series, so that users only get the time series in the time frame they want it.</li>
</ul>
<section id="the-everything-please-endpoint" class="level4">
<h4 class="anchored" data-anchor-id="the-everything-please-endpoint">The “Everything Please” endpoint</h4>
<ul>
<li>using the <code>GET</code> HTTP request</li>
<li>fetch the complete time series using the endpoint <code>/data</code></li>
</ul>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">library</span>(plumber)</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#* Return entire KOF Barometer time series</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#* @get /data</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="cf">function</span>() {</span>
<span id="cb10-5"><a href="#cb10-5"></a>  <span class="co"># the partition_ts function will be explained below!</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="fu">partition_ts</span>(data<span class="sc">$</span>kofbarometer)</span>
<span id="cb10-7"><a href="#cb10-7"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When you run your API, you get an interactive documentation interface (called Swagger) that looks like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/endpoints.png" class="img-fluid figure-img"></p>
<figcaption>API Endpoint Overview</figcaption>
</figure>
</div>
<p>Important to note here, is that you can see 3 different endpoints here (<code>/data</code>, <code>/filtered_data</code> and <code>/plotting</code> because those are the 3 endpoints we will create throughout this example, for now, just focus on the endpoint we just created: <code>/data</code>)</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/data_endpoint.png" class="img-fluid figure-img"></p>
<figcaption>The “Everything Please”</figcaption>
</figure>
</div>
<p>Since we just created the <code>/data</code> endpoint, see code snippet above, we will try it out and see the Response Body, which contains the entire Konjunkturbarometer time series.</p>
</section>
<section id="the-custom-order-endpoint" class="level4">
<h4 class="anchored" data-anchor-id="the-custom-order-endpoint">The “Custom Order” endpoint</h4>
<ul>
<li>creates the endpoint <code>/filtered_data</code> which</li>
<li>lets users specify date ranges as parameters:</li>
<li>e.g.<code>/data?start=2020&amp;end=2024</code> (Hint: these are the query parameters we introduced before)</li>
</ul>
<p>For this, we first need to create a function <code>partition_ts</code> which takes the parameters the API users pass to the endpoint, i.e.&nbsp;a start and end date. We then partition the time series according to those parameters.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co">#* @param ts time series object</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="co">#* @param start date at which ts should start - can be years only, or c(year, month)</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="co">#* @param end date at which ts should end - can be years only, or c(year, month)</span></span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a>partition_ts <span class="ot">&lt;-</span> <span class="cf">function</span>(ts, <span class="at">start =</span> <span class="cn">NULL</span>, <span class="at">end =</span> <span class="cn">NULL</span>) {</span>
<span id="cb11-6"><a href="#cb11-6"></a>  <span class="cf">if</span> (<span class="fu">inherits</span>(ts, <span class="st">"ts"</span>)) {</span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="co"># setting start and end date if unset</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(end)) {</span>
<span id="cb11-9"><a href="#cb11-9"></a>      end <span class="ot">&lt;-</span> <span class="fu">time</span>(ts)[<span class="fu">length</span>(ts)]</span>
<span id="cb11-10"><a href="#cb11-10"></a>    }</span>
<span id="cb11-11"><a href="#cb11-11"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(start)) {</span>
<span id="cb11-12"><a href="#cb11-12"></a>      start <span class="ot">&lt;-</span> <span class="fu">time</span>(ts)[<span class="dv">1</span>]</span>
<span id="cb11-13"><a href="#cb11-13"></a>    }</span>
<span id="cb11-14"><a href="#cb11-14"></a>    <span class="co"># filter ts based on start &amp; end dates</span></span>
<span id="cb11-15"><a href="#cb11-15"></a>    ts <span class="ot">&lt;-</span> <span class="fu">window</span>(ts, <span class="at">start =</span> start, <span class="at">end =</span> end)</span>
<span id="cb11-16"><a href="#cb11-16"></a>  } <span class="cf">else</span> {</span>
<span id="cb11-17"><a href="#cb11-17"></a>    <span class="fu">warning</span>(<span class="st">"Input is not a ts object"</span>)</span>
<span id="cb11-18"><a href="#cb11-18"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb11-19"><a href="#cb11-19"></a>  }</span>
<span id="cb11-20"><a href="#cb11-20"></a>  <span class="fu">return</span>(ts)</span>
<span id="cb11-21"><a href="#cb11-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We use the <code>partition_ts</code> function to create our new endpoint function</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#* Return KOF Barometer data with custom date range</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="co">#* @param start the start year to filter by</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="co">#* @param end the end year to filter by</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="co">#* @get /filtered_data</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="cf">function</span>(<span class="at">start =</span> <span class="cn">NULL</span>, <span class="at">end =</span> <span class="cn">NULL</span>) {</span>
<span id="cb12-6"><a href="#cb12-6"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(start)) {</span>
<span id="cb12-7"><a href="#cb12-7"></a>    start <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(start)</span>
<span id="cb12-8"><a href="#cb12-8"></a>  }</span>
<span id="cb12-9"><a href="#cb12-9"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(end)) {</span>
<span id="cb12-10"><a href="#cb12-10"></a>    end <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(end)</span>
<span id="cb12-11"><a href="#cb12-11"></a>  }</span>
<span id="cb12-12"><a href="#cb12-12"></a></span>
<span id="cb12-13"><a href="#cb12-13"></a>  <span class="fu">partition_ts</span>(</span>
<span id="cb12-14"><a href="#cb12-14"></a>    data<span class="sc">$</span>kofbarometer,</span>
<span id="cb12-15"><a href="#cb12-15"></a>    <span class="at">start =</span> start,</span>
<span id="cb12-16"><a href="#cb12-16"></a>    <span class="at">end =</span> end</span>
<span id="cb12-17"><a href="#cb12-17"></a>  )</span>
<span id="cb12-18"><a href="#cb12-18"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s create our own API that shares KOF Barometer data. We’ll build endpoints where users can:</p>
<ul>
<li>using the same endpoint from above</li>
<li>Get data from specific periods: <code>/data?start=2020&amp;end=2024</code></li>
<li>Even get a chart: <code>/plot</code></li>
</ul>
<p>Let’s test the <code>/filtered_data</code> endpoint by requesting KOF Barometer data from 2010 onwards:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/set_params.png" class="img-fluid figure-img"></p>
<figcaption>Setting parameters for your API request</figcaption>
</figure>
</div>
<p>Hit “Execute” and voila—the Server response shows the exact data requested:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/get_requests.png" class="img-fluid figure-img"></p>
<figcaption>Your API returning filtered economic data</figcaption>
</figure>
</div>
</section>
<section id="the-visual-takeaway-endpoint" class="level4">
<h4 class="anchored" data-anchor-id="the-visual-takeaway-endpoint">The “Visual Takeaway” endpoint</h4>
<ul>
<li>we create the <code>/plotting</code> endpoint</li>
<li>using the <code>GET</code> request, we return ready-made charts:</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a><span class="co">#* Return KOF Barometer chart as PNG</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="co">#* @serializer png</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="co">#* @get /plotting</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="cf">function</span>() {</span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="fu">plot</span>(data<span class="sc">$</span>kofbarometer)</span>
<span id="cb13-6"><a href="#cb13-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/plot_endpoint.png" class="img-fluid figure-img"></p>
<figcaption>Using the /plotting Endpoint</figcaption>
</figure>
</div>
<p><strong>Important to Note</strong>: The images you see above is the API Documentation which is automatically generated when using the plumber R package. Swagger is your API’s user-friendly interface, but behind the scenes, your API users will interact with your API through HTTP requests, as already shown above. In this example, a Get Request can be executed in the browser like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/real_call.png" class="img-fluid figure-img"></p>
<figcaption>How real API calls work in practice</figcaption>
</figure>
</div>
<p>If you want to test out how to use the plumber R package to create your own API, incl.&nbsp;the API documentation , then I encourage you to do so. However, for this, consult the <a href="https://www.rplumber.io/">plumber documentation</a> and make sure to do this:</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Testing Your API Locally
</div>
</div>
<div class="callout-body-container callout-body">
<p>Save all three functions in a file called <code>plumber.R</code> in the base of your working directory, then launch your API:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Launch your API on port 8000</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">pr</span>(<span class="st">"plumber.R"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>  <span class="fu">pr_run</span>(<span class="at">port=</span><span class="dv">8000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<p>Congratulations! You’ve just built your own API!</p>
<p>I hope you were able to learn something through this blog post, whether that is how APIs and APIs wrapper work and look like, or even how to build your own API (wrapper). In case you have any questions, feel free to contact me at <a href="mailto:heim@kof.ethz.ch">heim@kof.ethz.ch</a></p>
</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>https://kof.ethz.ch/en/forecasts-and-indicators/indicators/kof-economic-barometer.html<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>https://www.dontusethiscode.com/blog/2024-11-20_pandas_reshaping.html<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>Try executing the Get Request yourself in your browser: https://www.pxweb.bfs.admin.ch/api/v1/en/px-x-0204000000_106/px-x-0204000000_106.px<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>If you want to take a look at a sample solution of this task, check out: https://minnaheim.github.io/dh_guest_lecture_2025/presentation.html#/get-vaccine-rates je-d-04.02.01.03.xlsx<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>